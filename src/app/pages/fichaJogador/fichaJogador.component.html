<div class="container mt-4">

  <div class="d-flex justify-content-center" style="vertical-align:middle;">
    <div class="spinner-border text-danger" *ngIf="spinner" styrole="status">
      <span class="sr-only"></span>
    </div>
  </div>





  <div class="row justify-content-center" *ngIf="!spinner">
    <div class="col-md-4">
      <div class="card profile-card text-center shadow">
        <div *ngIf="!tirarFoto">
          <img [src]="fotoUrl" onerror="this.onerror=null; this.src='assets/img/jogadores/default.jpg'"
            alt="Foto do Jogador">


        </div>
        <input type="text" class="form-control"
          style="font-weight: bold; color:black; font-size: x-large; text-align: center; border: none;"
          [(ngModel)]="jogadorData.nome" readonly="true">
        <p class="text-muted">Nº Camisola</p>
        <input type="text" class="form-control number-input" [(ngModel)]="jogadorData.numero" readonly="true">
      </div>
    </div>

    <div class="col-md-8">
      <div class="modern-card shadow">
        <div class="card-header-modern">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="icon-circle me-3">
                <img [src]="avatarUrl" onerror="this.onerror=null; this.src='assets/img/jogadores/default_avatar.jpg'" alt=""
                     class="rounded-circle" style="width: 30px; height: 30px;" />
              </div>
              <div>
                <h5 class="mb-0 fw-bold" style="color: #495057;">Informações Pessoais</h5>
                <small style="color: #6c757d;">Dados do jogador</small>
              </div>
            </div>
            <button type="button" class="btn-toggle-modern" (click)="toggleInfoVisibility()">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path *ngIf="!showInfo" d="M3.646 6.146a.5.5 0 0 1 .708 0L8 9.793l3.646-3.647a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 0-.708z" />
                <path *ngIf="showInfo" d="M3.646 9.146a.5.5 0 0 1 .708 0L8 12.793l3.646-3.647a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 0-.708z" />
              </svg>
            </button>
          </div>
        </div>

        <div class="card-body-modern" *ngIf="showInfo">
          <form #staffForm="ngForm">
          <div class="form-row">
            <div class="col-md-7">
              <div class="form-group">
                <label>Nome completo</label>
                <input type="text" class="form-control" name="nome_completo" [(ngModel)]="jogadorData.nome_completo"
                  [readonly]="!isEditing" [class.readonly]="!isEditing">
              </div>
            </div>
            <div class="col-md-5 pr-1">
              <div class="form-group">
                <label>Nome curto</label>
                <input type="text" class="form-control" name="nome" [(ngModel)]="jogadorData.nome"
                  [readonly]="!isEditing" [class.readonly]="!isEditing">

              </div>
            </div>
            <div class="col-md-2 pl-1">
              <div class="form-group">
                <label>Nº Camisola</label>
                <input type="text" class="form-control" name="numero" [(ngModel)]="jogadorData.numero"
                  [readonly]="!isEditing" [class.readonly]="!isEditing">
              </div>
            </div>
            <div class="col-md-5">
              <div class="form-group">
                <label>Data Nascimento</label>
                <input type="text" class="form-control" name="data_nascimento" [(ngModel)]="dataNascimentoDisplay"
                  [readonly]="!isEditing" [class.readonly]="!isEditing">
              </div>
            </div>
          </div>
          <div #collapse="ngbCollapse" [(ngbCollapse)]="isCollapsed">
            <div class="row">
              <div class="col-md-4 pr-1">
                <div class="form-group">
                  <label>Cartão Cidadão</label>
                  <input type="text" class="form-control" placeholder="" name="cc" [(ngModel)]="jogadorData.cc"
                    [readonly]="!isEditing" [class.readonly]="!isEditing">
                </div>
              </div>
              <div class="col-md-4 px-1">
                <div class="form-group">
                  <label>Contribuinte</label>
                  <input type="text" class="form-control" placeholder="" name="nif" [(ngModel)]="jogadorData.nif"
                    [readonly]="!isEditing" [class.readonly]="!isEditing">
                </div>
              </div>
              <div class="col-md-4 pl-1">
                <div class="form-group">
                  <label>Nº Licença</label>
                  <input type="text" class="form-control" placeholder="" name="licenca"
                    [(ngModel)]="jogadorData.licenca" [readonly]="!isEditing" [class.readonly]="!isEditing">
                </div>
              </div>
            </div>
            <div class="row">
              <div class="pl-1 ml-auto mr-auto">
                <div class="form-group">
                  <label>Email</label>
                  <input type="text" class="form-control" placeholder="" name="email" [(ngModel)]="jogadorData.email"
                    [readonly]="!isEditing" [class.readonly]="!isEditing">
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 pr-1">
                <div class="form-group">
                  <label>Pai</label>
                  <input type="text" class="form-control" placeholder="" name="pai_nome"
                    [(ngModel)]="jogadorData.pai_nome" [readonly]="!isEditing" [class.readonly]="!isEditing">
                </div>
              </div>
              <div class="col-md-6 pl-1">
                <div class="form-group">
                  <label>Mãe</label>
                  <input type="text" class="form-control" placeholder="" name="mae_nome"
                    [(ngModel)]="jogadorData.mae_nome" [readonly]="!isEditing" [class.readonly]="!isEditing">
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 pr-1">
                <div class="form-group">
                  <label>Telefone (Pai)</label>
                  <input type="text" class="form-control" placeholder="" name="pai_telemovel"
                    [(ngModel)]="jogadorData.pai_telemovel" [readonly]="!isEditing" [class.readonly]="!isEditing">
                </div>
              </div>
              <div class="col-md-6 pl-1">
                <div class="form-group">
                  <label>Telefone (Mãe)</label>
                  <input type="text" class="form-control" placeholder="" name="mae_telemovel"
                    [(ngModel)]="jogadorData.mae_telemovel" [readonly]="!isEditing" [class.readonly]="!isEditing">
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 pr-1">
                <div class="form-group">
                  <label>email (Pai)</label>
                  <input type="text" class="form-control" placeholder="" name="pai_email"
                    [(ngModel)]="jogadorData.pai_email" [readonly]="!isEditing" [class.readonly]="!isEditing">
                </div>
              </div>
              <div class="col-md-6 pl-1">
                <div class="form-group">
                  <label>email (Mãe)</label>
                  <input type="text" class="form-control" placeholder="" name="mae_email"
                    [(ngModel)]="jogadorData.mae_email" [readonly]="!isEditing" [class.readonly]="!isEditing">
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">
                <div class="form-group">
                  <label>Morada</label>
                  <input type="text" class="form-control" placeholder="" name="morada" [(ngModel)]="jogadorData.morada"
                    [readonly]="!isEditing" [class.readonly]="!isEditing">
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 pr-1">
                <div class="form-group">
                  <label>Cidade</label>
                  <input type="text" class="form-control" placeholder="" name="cidade" [(ngModel)]="jogadorData.cidade"
                    [readonly]="!isEditing" [class.readonly]="!isEditing">
                </div>
              </div>

              <div class="col-md-4 pl-1">
                <div class="form-group">
                  <label>Código Postal</label>
                  <input type="text" class="form-control" name="codigo_postal" [(ngModel)]="jogadorData.codigo_postal"
                    [readonly]="!isEditing" [class.readonly]="!isEditing">
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">
                <div class="form-group">
                  <label>Observações</label>
                  <textarea class="form-control textarea" name="observacoes" [(ngModel)]="jogadorData.observacoes"
                    [readonly]="!isEditing" [class.readonly]="!isEditing"></textarea>
                </div>
              </div>
            </div>

          </div>

          <!-- Botões -->
          <div class="mt-4">
            <button *ngIf="!isEditing" type="button" class="btn btn-info btn-sm mr-1" (click)="startEditing()">
              <i class="nc-icon nc-ruler-pencil"></i> Editar
            </button>

            <button *ngIf="isEditing" type="button" class="btn btn-success btn-sm mr-1" (click)="gravarFichaJogador()"
              [disabled]="staffForm.invalid">
              <i class="nc-icon nc-check-2"></i> Gravar
            </button>

            <button *ngIf="isEditing" type="button" class="btn btn-secondary btn-sm" (click)="cancelEditing()">
              <i class="nc-icon nc-simple-remove"></i> Cancelar
            </button>

            <button *ngIf="isEditing" type="button" class="btn btn-info btn-sm" (click)="modoCarregarFicheiro()">
              <i class="nc-icon nc-image<"></i> Alterar Foto Perfil
            </button>

            <button *ngIf="isEditing" type="button" class="btn btn-info btn-sm" (click)="modoCarregarFicheiro_avatar()">
              <i class="nc-icon nc-camera-20"></i> Alterar Foto Avatar
            </button>
          </div>

          <div *ngIf="isUploadFoto">
            <input type="file" (change)="onFileSelected($event)" class="form-control-file mb-2">
          </div>
          <div *ngIf="isUploadFoto_avatar">
            <input type="file" (change)="onFileSelected($event)" class="form-control-file mb-2">
          </div>

          </form>
        </div>
      </div>

      <div class="modern-card shadow mt-4">
        <div class="card-header-modern">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="icon-circle me-3">
                <i class="nc-icon nc-alert-circle-i text-white"></i>
              </div>
              <div>
                <h5 class="mb-0 fw-bold" style="color: #495057;">{{total_faltas}} Faltas</h5>
                <small style="color: #6c757d;">Registo disciplinar</small>
              </div>
            </div>
            <button type="button" class="btn-toggle-modern" (click)="toggleFaltasVisibility()">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path *ngIf="!showFaltas" d="M3.646 6.146a.5.5 0 0 1 .708 0L8 9.793l3.646-3.647a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 0-.708z" />
                <path *ngIf="showFaltas" d="M3.646 9.146a.5.5 0 0 1 .708 0L8 12.793l3.646-3.647a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 0-.708z" />
              </svg>
            </button>
          </div>
        </div>
        <div class="card-body-modern" *ngIf="showFaltas">
          <div *ngIf="hasFaltas">
            <div class="faltas-list">
              <div *ngFor="let falta of faltas" class="falta-card">
                <div class="falta-content">
                  <div class="falta-date">
                    <div class="date-main">{{falta.data | data}}</div>
                    <small class="text-muted">{{falta.hora}}</small>
                  </div>
                  <div class="falta-details">
                    <div class="falta-escalao">
                      <span class="badge-escalao">{{falta.nome_escalao}}</span>
                    </div>
                    <div class="falta-info">
                      <div class="falta-tipo">{{falta.estado}}</div>
                      <div class="falta-motivo">{{falta.motivo}}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="!hasFaltas" class="empty-state">
            <div class="empty-icon">
              <i class="nc-icon nc-check-2"></i>
            </div>
            <p class="mb-0 text-muted">Sem registos de faltas</p>
          </div>
        </div>
      </div>





      <div class="modern-card shadow mt-4">
        <div class="card-header-modern">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="icon-circle me-3">
                <i class="nc-icon nc-calendar-60 text-white"></i>
              </div>
              <div>
                <h5 class="mb-0 fw-bold" style="color: #495057;">{{total_presencas}} Presenças</h5>
                <small style="color: #6c757d;">Assiduidade nos treinos</small>
              </div>
            </div>
            <button type="button" class="btn-toggle-modern" (click)="togglePresencasVisibility()">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path *ngIf="!showPresencas" d="M3.646 6.146a.5.5 0 0 1 .708 0L8 9.793l3.646-3.647a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 0-.708z" />
                <path *ngIf="showPresencas" d="M3.646 9.146a.5.5 0 0 1 .708 0L8 12.793l3.646-3.647a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 0-.708z" />
              </svg>
            </button>
          </div>
        </div>

        <div class="card-body-modern" *ngIf="showPresencas">
          <div *ngIf="load_presencas" class="text-center py-4">
            <div class="spinner-modern">
              <div class="spinner-border text-primary" role="status">
                <span class="sr-only"></span>
              </div>
              <p class="mt-2 text-muted small">Carregando presenças...</p>
            </div>
          </div>

          <div *ngIf="!load_presencas">
            <div class="presencas-grid">
              <div *ngFor="let presenca of count_presencas" class="presenca-card">
                <div class="presenca-header">
                  <h6 class="mb-0 fw-bold">{{presenca.escalao}}</h6>
                  <div class="total-badge">
                    Total: {{presenca.set + presenca.out + presenca.nov + presenca.dez + presenca.jan + presenca.fev + presenca.mar + presenca.abr + presenca.mai + presenca.jun + presenca.jul}}
                  </div>
                </div>
                <div class="presenca-months">
                  <div class="month-item">
                    <span class="month-label">Set</span>
                    <span class="month-value">{{presenca.set}}</span>
                  </div>
                  <div class="month-item">
                    <span class="month-label">Out</span>
                    <span class="month-value">{{presenca.out}}</span>
                  </div>
                  <div class="month-item">
                    <span class="month-label">Nov</span>
                    <span class="month-value">{{presenca.nov}}</span>
                  </div>
                  <div class="month-item">
                    <span class="month-label">Dez</span>
                    <span class="month-value">{{presenca.dez}}</span>
                  </div>
                  <div class="month-item">
                    <span class="month-label">Jan</span>
                    <span class="month-value">{{presenca.jan}}</span>
                  </div>
                  <div class="month-item">
                    <span class="month-label">Fev</span>
                    <span class="month-value">{{presenca.fev}}</span>
                  </div>
                  <div class="month-item">
                    <span class="month-label">Mar</span>
                    <span class="month-value">{{presenca.mar}}</span>
                  </div>
                  <div class="month-item">
                    <span class="month-label">Abr</span>
                    <span class="month-value">{{presenca.abr}}</span>
                  </div>
                  <div class="month-item">
                    <span class="month-label">Mai</span>
                    <span class="month-value">{{presenca.mai}}</span>
                  </div>
                  <div class="month-item">
                    <span class="month-label">Jun</span>
                    <span class="month-value">{{presenca.jun}}</span>
                  </div>
                  <div class="month-item">
                    <span class="month-label">Jul</span>
                    <span class="month-value">{{presenca.jul}}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>


      <!-- NOVO CARD SIMPLIFICADO: Jogos Participados (após o card de Presenças) -->
            <!-- NOVO CARD CORRIGIDO: Jogos por Escalão -->
      <div class="modern-card shadow mt-4">
        <div class="card-header-modern">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="icon-circle me-3">
                <i class="nc-icon nc-trophy text-white"></i>
              </div>
              <div>
                <h5 class="mb-0 fw-bold" style="color: #495057;">Jogos por Escalão</h5>
                <small style="color: #6c757d;">Histórico de participações</small>
              </div>
            </div>
            <button type="button" class="btn-toggle-modern" (click)="toggleJogosVisibility()">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path *ngIf="!showJogos" d="M3.646 6.146a.5.5 0 0 1 .708 0L8 9.793l3.646-3.647a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 0-.708z" />
                <path *ngIf="showJogos" d="M3.646 9.146a.5.5 0 0 1 .708 0L8 12.793l3.646-3.647a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 0-.708z" />
              </svg>
            </button>
          </div>
        </div>

  <!-- Conteúdo com Spinner e Controle de Visibilidade -->
  <div class="card-body-modern" *ngIf="showJogos">
    <div *ngIf="loadingJogos" class="text-center py-4">
      <div class="spinner-modern">
        <div class="spinner-border text-primary" role="status">
          <span class="sr-only"></span>
        </div>
        <p class="mt-2 text-muted small">Carregando jogos...</p>
      </div>
    </div>

    <div *ngIf="!loadingJogos">
      <!-- Lista de Escalões com Design Moderno -->
      <div class="escalao-list">
        <div *ngFor="let item of jogosPorEscalao" class="escalao-item" (click)="toggleJogosDetail(item)">
          <div class="escalao-header">
            <div class="d-flex justify-content-between align-items-center">
              <div class="escalao-info">
                <h6 class="mb-0 fw-bold">{{ item.escalao }}</h6>
                <small class="text-muted">{{ item.jogos.length }} jogos</small>
              </div>
              <div class="expand-icon">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" [class.rotated]="expandedEscalao === item.escalao">
                  <path d="M3.646 6.146a.5.5 0 0 1 .708 0L8 9.793l3.646-3.647a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 0-.708z"/>
                </svg>
              </div>
            </div>
          </div>

          <!-- Jogos expandidos -->
          <div class="jogos-expanded" *ngIf="expandedEscalao === item.escalao">
            <div class="jogos-list">
              <div *ngFor="let jogo of item.jogos" class="jogo-card" (click)="navigateToJogo(jogo.id)">
                <div class="jogo-content-linear">
                  <div class="jogo-date">
                    <small class="text-muted">{{ jogo.data | date:'dd/MM' }}</small>
                  </div>
                  <div class="jogo-opponent-compact">
                    <img src="assets/img/clubes/clube_{{ jogo.equipa_adv_id }}.png"
                         onerror="this.onerror=null; this.src='assets/img/clubes/default_clube.png'"
                         class="opponent-logo-small" />
                    <span class="opponent-name-compact">{{ jogo.equipa_adv_nome }}</span>
                    <small *ngIf="jogo.tipoEquipa_adv==='B'" class="text-muted">({{jogo.tipoEquipa_adv}})</small>
                  </div>
                  <div class="jogo-result">
                    <span *ngIf="jogo.estado === 'CONCLUIDO' && jogo.tipo_local==='C'" [ngClass]="{
                      'result-win': jogo.golos_equipa_adv < jogo.golos_equipa,
                      'result-loss': jogo.golos_equipa_adv > jogo.golos_equipa,
                      'result-draw': jogo.golos_equipa_adv === jogo.golos_equipa
                    }">{{jogo.golos_equipa}} - {{jogo.golos_equipa_adv}}</span>
                    <span *ngIf="jogo.estado === 'CONCLUIDO' && jogo.tipo_local==='F'" [ngClass]="{
                      'result-win': jogo.golos_equipa_adv < jogo.golos_equipa,
                      'result-loss': jogo.golos_equipa_adv > jogo.golos_equipa,
                      'result-draw': jogo.golos_equipa_adv === jogo.golos_equipa
                    }">{{jogo.golos_equipa_adv}} - {{jogo.golos_equipa}}</span>
                    <span *ngIf="jogo.estado !== 'CONCLUIDO'" class="text-muted small"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Total Geral Moderno -->
      <div *ngIf="jogosPorEscalao.length > 0" class="total-summary">
        <div class="total-badge">
          <i class="nc-icon nc-trophy me-2"></i>
          Total: {{ totalGeralJogos }} jogos
        </div>
      </div>

      <!-- Mensagem quando não há jogos -->
      <div *ngIf="jogosPorEscalao.length === 0" class="empty-state">
        <div class="empty-icon">
          <i class="nc-icon nc-trophy"></i>
        </div>
        <p class="mb-0 text-muted">Nenhum jogo encontrado para este jogador.</p>
      </div>
    </div>
  </div>
</div>




    </div>
  </div>
</div>