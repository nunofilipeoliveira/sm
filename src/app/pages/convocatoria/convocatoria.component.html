<div *ngIf="loading" class="loading-indicator">
    <p></p>
</div>

<div *ngIf="!loading" class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <!-- T√≠tulo Principal Mais Bonito com Logotipo da Equipa -->
            <div class="header-section mb-4">
                <div class="d-flex align-items-center justify-content-between bg-primary text-white p-3 rounded-top">
                    <div class="d-flex align-items-center">
                        <img src="assets/img/clubes/clube_{{ meuClubeid }}.png"
                            onerror="this.onerror=null; this.src='assets/img/clubes/default_clube.png'"
                            alt="Logotipo da Equipa" class="logo-equipa me-3" />
                        <div>
                            <h2 class="mb-1"><i class="nc-icon nc-trophy me-2"></i>Convocat√≥ria para o Jogo</h2>

                        </div>
                    </div>
                    <div class="text-end">
                        <span *ngIf="!isModoVisualizacao" class="badge bg-light text-dark fs-6">{{ selecionadosCount }}
                            / {{ totalAtletas }} Atletas
                            Selecionados</span>
                        <span *ngIf="isModoVisualizacao" class="badge bg-light text-dark fs-6">{{ totalAtletas }}
                            Atletas Convocados</span>
                    </div>
                </div>

            </div>

            <div *ngIf="loading" class="d-flex justify-content-center my-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only"></span>
                </div>
            </div>

            <ngb-alert type="success" *ngIf="sbmSuccess" (closed)="sbmSuccess = false">
                <i class="nc-icon nc-check-2 me-2"></i>Convocat√≥ria salva com sucesso!
            </ngb-alert>
            <ngb-alert type="danger" *ngIf="sbmError" (closed)="sbmError = false">
                <i class="nc-icon nc-alert-circle-i me-2"></i>{{ errorMessage }}
            </ngb-alert>

            <div *ngIf="!loading && jogo">
                <!-- Card de Detalhes do Jogo com Logotipos -->
                <!-- Card de Detalhes do Jogo com Logotipos -->
                <div class="card shadow-lg mb-4">
                    <div class="card-header bg-info text-white d-flex align-items-center justify-content-between">
                        <h5 class="card-title mb-0"><i class="nc-icon nc-calendar-60 me-2"></i>Detalhes do Jogo</h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div *ngIf="jogo.tipo_local=='C'" class="text-center col-12">
                                <img src="assets/img/clubes/clube_{{ meuClubeid }}.png"
                                    onerror="this.onerror=null; this.src='assets/img/clubes/default_clube.png'"
                                    alt="Nossa Equipa" class="logo-jogo me-2" />
                                <b>{{ nomeEscalao }}<span *ngIf="jogo.tipoEquipa==='B'">({{jogo.tipoEquipa}})</span></b>
                                <h6 class="text-muted mb-2">VS</h6>
                                <div class="text-center">
                                    <img src="assets/img/clubes/clube_{{ jogo.equipa_adv_id }}.png"
                                        onerror="this.onerror=null; this.src='assets/img/clubes/default_clube.png'"
                                        alt="Advers√°rio" class="logo-jogo me-2" /><strong>{{ jogo.equipa_adv_nome }}
                                        <span
                                            *ngIf="jogo.tipoEquipa_adv==='B'">({{jogo.tipoEquipa_adv}})</span></strong>
                                </div>
                                <p></p>
                                {{ jogo.local }} | <img src="assets/img/competicoes/c_{{ jogo.competicao_id }}.png"
                                    class="flag-icon" /> {{ jogo.competicao_nome }}<span *ngIf="jogo.numeroJogo"> (Jogo
                                    N¬∫:{{jogo.numeroJogo}} )</span>
                                <p></p>
                                {{ jogo.data | date:'dd/MM/yyyy' }} √†s {{ jogo.hora }}
                            </div>

                            <div *ngIf="jogo.tipo_local=='F'" class="text-center col-12">
                                <div class="text-center">
                                    <img src="assets/img/clubes/clube_{{ jogo.equipa_adv_id }}.png"
                                        onerror="this.onerror=null; this.src='assets/img/clubes/default_clube.png'"
                                        alt="Advers√°rio" class="logo-jogo me-2" /><strong>{{ jogo.equipa_adv_nome }}
                                        <span
                                            *ngIf="jogo.tipoEquipa_adv==='B'">({{jogo.tipoEquipa_adv}})</span></strong>
                                </div>
                                <h6 class="text-muted mb-2">VS</h6>
                                <div class="text-center">
                                    <img src="assets/img/clubes/clube_{{ meuClubeid }}.png"
                                        onerror="this.onerror=null; this.src='assets/img/clubes/default_clube.png'"
                                        alt="Nossa Equipa" class="logo-jogo me-2" />
                                    <b>{{ nomeEscalao }} <span
                                            *ngIf="jogo.tipoEquipa==='B'">({{jogo.tipoEquipa}})</span></b>
                                </div>
                                <p></p>
                                {{ jogo.local }} | <img src="assets/img/competicoes/c_{{ jogo.competicao_id }}.png"
                                    class="flag-icon" /> {{ jogo.competicao_nome }} <span *ngIf="jogo.numeroJogo"> (Jogo
                                    N¬∫:{{jogo.numeroJogo}} )</span>
                                <p></p>
                                {{ jogo.data | date:'dd/MM/yyyy' }} √†s {{ jogo.hora }}
                            </div>

                            <!-- Nova Se√ß√£o: Hora de Concentra√ß√£o e Observa√ß√µes (Grid Responsiva) -->
                            <div class="col-12 mt-3">
                                <div class="row">
                                    <!-- Hora de Concentra√ß√£o -->
                                    <div class="col-md-6 mb-3">
                                        <div class="info-box" [class.edit-mode]="!isModoVisualizacao">

                                            <label class="info-label"> <i
                                                    class="nc-icon nc-time-alarm info-icon"></i>Hora de
                                                Concentra√ß√£o</label>
                                            <div class="info-value" *ngIf="isModoVisualizacao">
                                                {{ jogo.hora_concentracao }}
                                            </div>
                                            <input *ngIf="!isModoVisualizacao" type="time"
                                                class="form-control info-input" [(ngModel)]="jogo.hora_concentracao"
                                                placeholder="HH:MM">
                                        </div>
                                    </div>

                                    <!-- Observa√ß√µes -->
                                    <div *ngIf="jogo.obs || !isModoVisualizacao" class="col-md-6 mb-3">
                                        <div class="info-box" [class.edit-mode]="!isModoVisualizacao">
                                            <i class="nc-icon nc-notes info-icon"></i>
                                            <label class="info-label">Observa√ß√µes</label>
                                            <div class="info-value" *ngIf="isModoVisualizacao">
                                                {{ jogo.obs }}
                                            </div>
                                            <input *ngIf="!isModoVisualizacao" type="text"
                                                class="form-control info-input" [(ngModel)]="jogo.obs"
                                                placeholder="Adicione observa√ß√µes...">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Card de Sele√ß√£o de Atletas -->
                <div class="card shadow-lg mb-4">
                    <div *ngIf="!isModoVisualizacao" class="card-header bg-success text-white">
                        <h5 class="card-title mb-0"><i class="nc-icon nc_users-1 me-2"></i>Selecionar Atletas para
                            Convocat√≥ria</h5>
                        <small class="text-white-50">Clique em uma linha para selecionar ou deselecionar o
                            atleta</small>
                    </div>
                    <div *ngIf="isModoVisualizacao" class="card-header bg-success text-white">
                        <h5 class="card-title mb-0"><i class="nc-icon nc_users-1 me-2"></i>Atletas Convocados</h5>

                    </div>
                    <div class="card-body p-0">
                        <div *ngIf="atletasDisponiveis.length > 0">
                            <table class="table project-list-table table-nowrap align-middle table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th width="60"></th>
                                        <th>Nome do Atleta</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let atleta of atletasDisponiveis" [class.selected]="atleta.selecionado"
                                        (click)="toggleSelecao(atleta)" class="atleta-row">
                                        <td>
                                            <i *ngIf="atleta.selecionado && !isModoVisualizacao"
                                                class="nc-icon nc-check-2 text-success"></i>
                                            <i *ngIf="!atleta.selecionado"
                                                class="nc-icon nc-simple-remove text-muted"></i>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img src="assets/img/jogadores/{{atleta.id_jogador}}_avatar.jpg"
                                                    onerror="this.onerror=null; this.src='assets/img/jogadores/default_avatar.jpg'"
                                                    alt="{{ atleta.nome_jogador }}"
                                                    class="avatar-md rounded-circle me-3" />
                                                <span class="atleta-nome">{{ atleta.nome_jogador }}</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div *ngIf="atletasDisponiveis.length === 0" class="text-center text-muted py-4">
                            <i class="nc-icon nc_users fs-1 mb-2"></i>
                            <p>Nenhum atleta dispon√≠vel para sele√ß√£o.</p>
                        </div>
                    </div>
                </div>

                <!-- Card de Sele√ß√£o de Atletas Indisponiveis -->
                <div class="card shadow-lg mb-4">
                    <div *ngIf="!isModoVisualizacao || atletasIndisponiveis.length > 0"
                        class="card-header bg-danger text-white">
                        <h5 class="card-title mb-0"><i class="nc-icon nc_users-1 me-2"></i>Atletas Indispon√≠veis</h5>
                        <small *ngIf="!isModoVisualizacao" class="text-white-50">Adicionar as indisponibilidades</small>
                    </div>

                    <div class="card-body p-0">
                        <div *ngIf="atletasIndisponiveis.length > 0">
                            <table class="table project-list-table table-nowrap align-middle table table-hover">
                                <thead class="table-light">
                                    <tr>

                                        <th>Nome do Atleta</th>
                                        <th>Observa√ß√£o</th> <!-- Nova coluna para Obs -->
                                        <th *ngIf="!isModoVisualizacao" width="60">A√ß√£o</th>
                                        <!-- Coluna para toggle, se necess√°rio -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let atleta of atletasIndisponiveis"
                                        [class.selected]="atleta.selecionado" (click)="toggleSelecao(atleta)"
                                        class="atleta-row">

                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img src="assets/img/jogadores/{{atleta.id_jogador}}_avatar.jpg"
                                                    onerror="this.onerror=null; this.src='assets/img/jogadores/default_avatar.jpg'"
                                                    alt="{{ atleta.nome_jogador }}"
                                                    class="avatar-md rounded-circle me-3" />
                                                <span class="atleta-nome">{{ atleta.nome_jogador }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span *ngIf="atleta.obs && atleta.obs.trim() !== ''"
                                                class="badge bg-secondary">{{ atleta.obs }}</span>
                                            <span *ngIf="!atleta.obs || atleta.obs.trim() === ''" class="text-muted">Sem
                                                observa√ß√£o</span>
                                        </td>
                                        <td *ngIf="!isModoVisualizacao">
                                            <!-- Bot√£o para remover de indispon√≠veis e voltar para dispon√≠veis, se necess√°rio -->
                                            <button *ngIf="!isModoVisualizacao" class="btn btn-sm btn-outline-primary"
                                                (click)="removerIndisponivel(atleta); $event.stopPropagation()">
                                                -
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div *ngIf="!isModoVisualizacao && atletasIndisponiveis.length === 0"
                            class="text-center text-muted py-4">
                            <i class="nc-icon nc_users fs-1 mb-2"></i>
                            <p>Nenhum atleta indispon√≠vel para sele√ß√£o.</p>
                        </div>

                        <div *ngIf="!isModoVisualizacao" class="text-center mt-1">
                            <button class="btn btn-primary" (click)="adicionarIndisponibilidade()">
                                <b>+</b> Adicionar Indispon√≠vel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Bot√µes de A√ß√£o -->
                <div class="d-flex justify-content-between ">
                    <button type="button" class="btn btn-secondary btn-lg" (click)="voltar()">
                        <i class="nc-icon nc-minimal-left me-2"></i> Voltar
                    </button>
                    <button *ngIf="isModoVisualizacao" type="button" class="btn btn-warning btn-lg"
                        (click)="editarConvocatoria()">
                        <i class="nc-icon me-2"></i> Editar Convocat√≥ria
                    </button>
                    <button *ngIf="isModoVisualizacao" type="button" class="btn btn-info btn-lg"
                        (click)="gerarImagemComFotos()">
                        <i class="nc-icon me-2"></i> Partilhar Convocat√≥ria
                    </button>
                    <button *ngIf="!isModoVisualizacao" type="button" class="btn btn-info btn-lg"
                        (click)="adicionarJogador()">
                        <i class="nc-icon me-2"></i> Adicionar outros jogadores
                    </button>
                    <button *ngIf="!isModoVisualizacao" type="button" class="btn btn-success btn-lg"
                        (click)="salvarConvocatoria()" [disabled]="selecionadosCount === 0">
                        <i class="nc-icon nc-check-2 me-2"></i> Confirmar Convocat√≥ria ({{ selecionadosCount }}
                        Selecionados)
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>



<div class="modal-backdrop fade" [class.show]="mostrarModalIndisponivel" *ngIf="mostrarModalIndisponivel"></div>

<div class="modal fade" [class.show]="mostrarModalIndisponivel"
    [style.display]="mostrarModalIndisponivel ? 'block' : 'none'" tabindex="-1" role="dialog"
    *ngIf="mostrarModalIndisponivel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title mb-0">Adicionar Jogador Indispon√≠vel</h5>
                <button type="button" class="btn-close btn-close-white" (click)="cancelarIndisponivel()"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group mb-3">
                        <label for="jogadorIndisponivel">Selecionar Jogador *</label>
                        <select class="form-select" id="jogadorIndisponivel"
                            [(ngModel)]="jogadorSelecionadoIndisponivel" name="jogadorIndisponivel" required>
                            <option [ngValue]="null" disabled selected>Escolha um jogador dispon√≠vel</option>
                            <option *ngFor="let atleta of atletasDisponiveis" [ngValue]="atleta">
                                {{ atleta.nome_jogador }}
                            </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="obsIndisponivel">Observa√ß√£o (opcional)</label>
                        <input type="text" class="form-control" id="obsIndisponivel" [(ngModel)]="obsIndisponivel"
                            name="obsIndisponivel" placeholder="Ex: Lesionado, Suspenso, etc.">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="cancelarIndisponivel()">Cancelar</button>
                <button type="button" class="btn btn-primary" (click)="confirmarIndisponivel()"
                    [disabled]="!jogadorSelecionadoIndisponivel">Adicionar Indispon√≠vel</button>
            </div>
        </div>
    </div>
</div>





<!-- Div oculto para gerar a imagem da convocat√≥ria com avatares (atualizado para evitar cortes) -->
<div id="convocatoria-imagem"
    style="display: none; width: 600px; height: auto; background: #f8f9fa; padding: 18px; border-radius: 18px; box-shadow: 0 8px 25px rgba(0,0,0,0.15);  position: relative; overflow: hidden;">

    <!-- Fundo com logotipo obl√≠quo e transparente -->
    <img [src]="'assets/img/clubes/clube_' + meuClubeid + '.png'"
        onerror="this.src='assets/img/clubes/default_clube.png'" alt="Logotipo do Clube Fundo"
        style="position: absolute; top: -50px; left: -50px; width: 250px; height: 250px; opacity: 0.1; transform: rotate(-25deg); z-index: 0;" />

    <!-- Cabe√ßalho com logotipo principal e t√≠tulo -->
    <div style="text-align: center; margin-bottom: 25px; position: relative; z-index: 1;">
        <img [src]="'assets/img/clubes/clube_' + meuClubeid + '.png'"
            onerror="this.src='assets/img/clubes/default_clube.png'" alt="Logotipo do Clube"
            style="width: 100px; height: 100px; border-radius: 50%; margin-bottom: 18px; border: 4px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1);" />
        <h2 style="color: #273890; margin: 0; font-size: 28px; font-weight: 700;">Convocat√≥ria Oficial</h2>
        <p style="color: #6c757d; margin: 8px 0 0 0; font-size: 17px;"><strong>Equipa:</strong> {{ nomeEscalao }} <span
                *ngIf="jogo?.tipoEquipa==='B'">({{jogo.tipoEquipa}})</span></p>
    </div>

    <!-- Detalhes do Jogo -->
    <div
        style="background: #e9ecef; padding: 18px; border-radius: 10px; margin-bottom: 25px; text-align: center; position: relative; z-index: 1;">
        <h3 style="color: #b52732; margin: 0 0 12px 0; font-size: 18px; font-weight: 600;">Detalhes do Jogo</h3>
        <p style="margin: 5px 0; font-size: 18px; color: #495057;">
            <strong>Advers√°rio:</strong>
            <img src="assets/img/clubes/clube_{{ jogo.equipa_adv_id }}.png"
                onerror="this.onerror=null; this.src='assets/img/clubes/default_clube.png'" alt="Advers√°rio"
                style="width: 30px; height: 30px; border-radius: 50%; vertical-align: middle; margin-right: 8px; margin-left: 8px;" />
            {{ jogo.equipa_adv_nome || 'Indefinido' }} <span
                *ngIf="jogo.tipoEquipa_adv==='B'">({{jogo.tipoEquipa_adv}})</span>
        </p>
        <p style="margin: 5px 0; font-size: 18px; color: #495057;">
            <strong>Competi√ß√£o:</strong>
            <img src="assets/img/competicoes/c_{{ jogo.competicao_id }}.png" alt="Competi√ß√£o"
                style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px; margin-left: 8px;" />
            {{ jogo.competicao_nome || 'Indefinida' }}
        </p>
        <p *ngIf="jogo.numeroJogo" style="margin: 5px 0; font-size: 18px; color: #495057;">
            <strong>Jogo n¬∫:</strong>
            {{ jogo.numeroJogo}}
        </p>
        <p style="margin: 5px 0; font-size: 18px; color: #495057;"><strong>üóì </strong> {{ jogo.data |
            date:'dd/MM/yyyy' }} √†s {{ jogo.hora || 'Indefinida' }}</p>
        <p style="margin: 5px 0; font-size: 18px; color: #495057;"><strong>üìç</strong> {{ jogo.local || 'Indefinido' }}
        </p>
        <p style="margin: 5px 0; font-size: 18px; color: #495057;"><strong>Hora de concentra√ß√£o:</strong> {{
            jogo.hora_concentracao }}</p>
        <p *ngIf="jogo.obs" style="margin: 5px 0; font-size: 18px; color: #495057;"><strong>Observa√ß√µes:</strong> {{
            jogo.obs }}</p>


    </div>

    <!-- Lista de Convocados com Avatares -->
    <div style="margin-bottom: 25px; position: relative; z-index: 1;">
        <h3 style="color: #273890; margin: 0 0 18px 0; font-size: 22px; font-weight: 600; text-align: center;">Atletas
            Convocados</h3>
        <div *ngIf="selecionadosCount > 0; else semConvocados"
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 18px;">
            <div *ngFor="let atleta of getConvocados(); let i = index"
    style="display: flex; flex-direction: column; align-items: center; padding: 12px 18px; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">

    <!-- Subcont√™iner para a imagem e o nome -->
    <div style="display: flex; align-items: center; width: 100%;">
        <img [src]="'assets/img/jogadores/' + atleta.id_jogador + '_avatar.jpg'"
            onerror="this.src='assets/img/jogadores/default_avatar.jpg'" alt="{{ atleta.nome_jogador }}"
            style="width: 55px; height: 55px; border-radius: 50%; margin-right: 18px; object-fit: cover; border: 2px solid #273890;" />
        <span style="font-size: 20px; color: #343a40;">{{ atleta.nome_jogador }}</span>
    </div>

    <!-- Elemento para a licen√ßa, com a nova estiliza√ß√£o -->
    <span *ngIf="atleta.licenca"
        style="font-size: 14px; color: #343a40; text-align: center; width: 100%; margin-top: 2px; display: inline-block; padding: 6px 12px; background-color: #e9ecef; border-radius: 20px; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.05);"><span *ngIf="atleta.licenca!== '0'" >Licen√ßa: {{ atleta.licenca }}</span><span *ngIf="atleta.licenca== '0'" >- </span></span>
    
   
</div>

        </div>

        <ng-template #semConvocados>
            <p style="text-align: center; color: #999; font-style: italic; font-size: 16px;">Nenhum atleta convocado.
            </p>
        </ng-template>
    </div>




</div>